{"version":3,"sources":["/Users/jbr/code/sibilant/src/transpiler.sibilant"],"names":[],"mappings":"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","sourcesContent":[";; (def flatten-output (nodes)\n;;      (inject [] nodes\n;;              (#(collector item)\n;;                (if (list? item) (apply flatten-output item)\n;;                   (if \n                                \n\n(def node? (thing type)\n     (and\n      (exists? thing)\n      (= 'object (typeof thing))\n      (string? thing.type)\n      (or (undefined? type) (= thing.type type))\n      (thing.has-own-property 'contents)))\n\n(def empty-node? (item)\n     (if (node? item) (empty-node? item.contents)\n         (list? item) (all? item empty-node?)\n         (string? item) (item.match (regex \"^\\\\s*$\"))\n         (or (= null item)\n             (undefined? item)\n             (= false item))))\n\n(def compact-node (item)\n     (if (node? item) (do\n                       (set item 'contents (compact-node item.contents))\n                       (if (and item.contents item.contents.length) item null))\n         (list? item) (do\n                       (var compacted (compact (map item compact-node)))\n                       (if (and compacted compacted.length) compacted null))\n         (if (or (= item \"\") (= item false)) null item)))\n\n(def recurse-transpile (node)\n     (if (list? node) (map node recurse-transpile)\n         (and (node? node) (!= 'output node.type)) (transpile node)\n         (and (node? node) (= 'output node.type)) (do\n                                                   (set node 'contents (recurse-transpile node.contents))\n                                                   node)\n         node))\n\n(def transpile (node preprocessor)\n     (if\n      (string? node)\n      (assign node { type 'js token node contents []})\n\n      (number? node)\n      (assign node { type 'number token (node.to-string) contents []}))\n     \n     (if (list? node) node\n         (exists? node) (do\n                         (var transpiler (or (get transpile node.type) transpile.default))\n                         (var result (transpiler node))\n                         (var result-node (recurse-transpile (if (node? result) result\n                                              { contents result type 'output })))\n                         (set result-node\n                              'contents (compact (flatten result-node.contents))\n                              'source node)\n\n                         (when sibilant.debug\n                               (console.log (prettify node)\n                                            (red \"->\")\n                                            (prettify result-node)))\n\n                         (set node 'transpiled result-node)\n\n                         \n                         (if (empty-node? result-node) undefined\n                             result-node))))\n\n\n(set sibilant 'transpile transpile)\n\n(var reader-macros {})\n\n(def transpile.hat (node)\n     (var output (transpile (first node.contents)))\n     (set output 'contents [(\"macros.\" (first output.contents))])\n     output)\n\n(def transpile.tick (node)\n     (^quote.apply node node.contents))\n\n(def transpile.at (node)\n     (transpile (first node.contents)))\n\n(def transpile.dots (node)\n     (var child (first node.contents))\n     (set child 'dots node.token.length)\n     (var result (transpile child))\n     (set result 'dots node.token.length)\n     result)\n\n(def transpile.default (node)\n     node.token)\n\n(def transpile.output (node)\n     node)\n\n(def transpile.number (node)\n     (send (parse-float (node.token.replace (regex \",\" 'g) \"\")) to-string))\n\n(def transpile.root (node)\n     (if (= 1 node.contents.length)\n         (transpile (first node.contents))\n         (interleave \"\\n\" (compact (map node.contents as-statement)))))\n\n(def transpile.expression (node preprocessor)\n     (if node.contents.length\n         (do\n          (var head (first node.contents)\n               args (rest node.contents)\n               macro (get macros (output-formatter (transpile head))))\n\n          (when (exists? macro) (set head 'hint 'macro))\n\n          (when (and head (= 'string head.type))\n                (assign macro macros.concat args node.contents))\n\n          (when (undefined? macro)\n                (assign macro macros.call args node.contents))\n\n          (macro.apply node args))\n\n         \"null\"))\n\n(def transpile.bracket (node)\n     (apply macros.list node.contents))\n\n(def transpile.brace (node) (apply macros.hash node.contents))\n\n(def transpile.literal (node)\n     (var string node.token)\n     (inject (chain string\n                    (replace (regex \"\\\\*\" 'g) \"_\")\n                    (replace (regex \"\\\\?$\") \"__QUERY\")\n                    (replace (regex \"!$\") \"__BANG\"))\n             (string.match (regex \"-(.)\" 'g))\n             (#(return-string match)\n               (return-string.replace match\n                                      (send (second match) to-upper-case)))))\n\n(def transpile.string (node)\n     (chain node.token (split \"\\n\")\n            (join \"\\\\n\\\" +\\n\\\"\")))\n\n(def transpile.comment (node) null)\n\n"]}